---
title: "2-exploratory-analysis-3"
author: "Andrew Lien"
date: "June 20, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo = F, message = F, include = F}
library(ggplot2)
library(dplyr)
library(tidyr)
library(magrittr)
library(RColorBrewer)
water.ecoli <- read.csv("water.ecoli.csv", stringsAsFactors = F)
water.ecoli$materialtype %<>% as.factor()
```

# OVERVIEW

1. Collinearity
  a. Correlation Matrix
  b. Investigating Correlated Variables
  c. Removing Correlated Variables
2. Testing Frequencies
3. Investigating Relationships to Location
4. Investigating Relationships to Time

# 1. COLLINEARITY

## a. Correlation Matrix

Having the correlation matrix converted to a heatmap makes it easier to see that some pairs of variables are highly correlated (either very white or very black).

```{r echo = F, warning = F}
cor.table <- cor(water.ecoli[,5:length(water.ecoli)], use = "pairwise.complete.obs")
cor.table <- as.data.frame(cbind(rownames(cor.table), cor.table))
cor.table <- gather(cor.table, key = "V2", value = "cor.value", 2:length(cor.table))
cor.table$cor.value %<>% as.numeric()
ggplot(cor.table, aes(x = V1, y = V2)) +
  geom_tile(aes(fill = cor.value), color = "white") +
  scale_fill_gradient(low = "white", high = "black") +
  ggtitle("Correlation Heat Map") +
  xlab("Determinand1") +
  ylab("Determinand2") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## b. Investigating Correlated Variables

### Oxygen.Diss.mg.l and O.Diss..sat..

Both of these determinands are different measurement methods for the same physical property, so it makes sense that they are strongly correlated. Only One needs to be kept.

```{r echo = F, warning = F}
ggplot(water.ecoli, aes(x = Oxygen.Diss.mg.l, y = O.Diss..sat.., color = E.coli.C.MF.conform)) +
  geom_point(alpha = 0.2) +
  facet_wrap(~materialtype, scales = "free")
```

### Oxygen.Diss.mg.l and Temp.Water.cel

This negative correlation makes sense, because the solubility of gas in liquid is known to decrease as the temperature of the liquid increases.

```{r echo = F, warning = F}
ggplot(water.ecoli, aes(x = Temp.Water.cel, y = Oxygen.Diss.mg.l, color = E.coli.C.MF.conform)) +
  geom_point(alpha = 0.2) +
  facet_wrap(~materialtype, scales = "free")
```

### SALinsitu.ppt and Cu.Filtered.ug.l
 
Salinity is the measure of the amount of dissolved salts. The positive correlation between copper concentration and salinity in estuarine water suggests that copper might be one of the main salt constituents in estuarine water.

```{r echo = F, warning = F}
ggplot(water.ecoli, aes(x = SALinsitu.ppt, y = Cu.Filtered.ug.l, color = E.coli.C.MF.conform)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~materialtype, scales = "free")
```

## c. Removing Correlated Variables

```{r}
water.ecoli$O.Diss..sat.. <- NULL
```

# 2. Testing Frequencies

Each of the determinands are tested with different frequencies based on material type. This is visualized below to better understand the differences between each material type.

```{r}
# estuary
estuarycomponents <- select(filter(water.ecoli, water.ecoli$materialtype == "ESTUARINE WATER"), c(2, 5:18))
estuarycomponents <- cbind(estuarycomponents[1], is.na(estuarycomponents[2:15]))
estuarycomponents <- aggregate(estuarycomponents[2:15], estuarycomponents[1], FUN = sum)
# river
rivercomponents <- select(filter(water.ecoli, water.ecoli$materialtype == "RIVER / RUNNING SURFACE WATER"), c(2, 5:18))
rivercomponents <- cbind(rivercomponents[1], is.na(rivercomponents[2:15]))
rivercomponents <- aggregate(rivercomponents[2:15], rivercomponents[1], FUN = sum)
# sea
seacomponents <- select(filter(water.ecoli, water.ecoli$materialtype == "SEA WATER"), c(2, 5:18))
seacomponents <- cbind(seacomponents[1], is.na(seacomponents[2:15]))
seacomponents <- aggregate(seacomponents[2:15], seacomponents[1], FUN = sum)
# lake
lakecomponents <- select(filter(water.ecoli, water.ecoli$materialtype == "POND / LAKE / RESERVOIR WATER"), c(2, 5:18))
lakecomponents <- cbind(lakecomponents[1], is.na(lakecomponents[2:15]))
lakecomponents <- aggregate(lakecomponents[2:15], lakecomponents[1], FUN = sum)
# combine
frequencytable <- rbind(estuarycomponents, rivercomponents, seacomponents, lakecomponents)
rownames(frequencytable) <- frequencytable[,1]
frequencytable <- select(frequencytable, c(2:5, 7:15))
frequencytable %<>% t() %>% as.data.frame()
frequencytable <- as.data.frame(cbind(rownames(frequencytable), frequencytable))
frequencytable <- gather(frequencytable, key = "materialtype", value = "count", 2:5)
names(frequencytable)[1] <- "determinand"
frequencytable$materialtype %<>% as.factor() 
ggplot(frequencytable, aes(x = materialtype, y = count, fill = determinand)) + 
  geom_bar(position = "fill", stat = "identity") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(9, "Set1"))(length(unique(frequencytable$determinand)))) +
  scale_y_continuous(label = percent) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
