---
title: "Data Wrangling and Exploratory Analysis"
author: "Andrew Lien"
date: "May 24, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set()
```

## Data Wrangling

Note that this wrangling process will start from the file "water.raw" due to the excessive file size of the raw data (> 3.3 GB). This file can be downloaded at the project [google drive folder](https://drive.google.com/drive/folders/1CD8-oHrF6VQyjEdSL8v6PSWbstwB0T08?usp=sharing).

```{r results = "hide", message = FALSE}
# Import packages and files
library(dplyr)
library(tidyr)
library(magrittr)
water.raw <- read.csv("water.raw.csv", stringsAsFactors = F)

# Filtering data to 5 most common material types
materialswithecoli <- names(head(sort(table(filter(water.raw, water.raw$determinand.label == "E.coli C-MF")$materialtype), decreasing = T), 5))
water.raw.ecoli <- filter(water.raw, match(water.raw$materialtype, materialswithecoli) > 0)

# Filtering data to only the most significant determinands.
ecolideterminands <- c("E.coli C-MF", "Temp Water", "pH", "Oxygen Diss", "Sld Sus@105C", "SALinsitu", "Ammonia(N)", "Nitrite-N", "Nitrate-N", "COD as O2")
water.raw.ecoli <- filter(water.raw.ecoli, match(water.raw.ecoli$determinand.label, ecolideterminands) > 0 )
water.raw.ecoli %<>% droplevels()
water.raw.ecoli$determinand.label %<>% as.factor()

# Spread according to the column "determinand.label" to get tidy data.
water.raw.ecoli$X.id <- 1:nrow(water.raw.ecoli)
water.raw.ecoli <- spread(water.raw.ecoli, key = determinand.label, value = result)
water.raw.ecoli$X.id <- NULL

# Remove duplicate rows
water.raw.ecoli <- unique(water.raw.ecoli)

# Adding resultunit to column names.
for (i in 6:length(water.raw.ecoli)) {
  position <- grep(x = is.na(water.raw.ecoli[,i]), pattern = FALSE)[1]
  unit <- water.raw.ecoli[position, "resultunit"]
  colnames(water.raw.ecoli)[i] <- paste(colnames(water.raw.ecoli)[i], unit, sep = ".")
}
water.raw.ecoli$resultunit <- NULL

# Aggregate rows. 
water.raw.ecoli <- aggregate(water.raw.ecoli[,5:length(water.raw.ecoli)], water.raw.ecoli[,1:4], FUN = sum, na.rm = T)
water.raw.ecoli[water.raw.ecoli == 0] <- NA

# Filter to rows that have value for e. coli
water.raw.ecoli <- filter(water.raw.ecoli, is.na(water.raw.ecoli$`E.coli C-MF.no/100ml`) == F)

# Reorder rows to have e. coli adjacent to identifier columns.
water.raw.ecoli <- water.raw.ecoli[,c(1:4, 7, 5, 6, 8:length(water.raw.ecoli))]
```

A sample of the resulting dataset is shown below
```{r}
head(water.raw.ecoli, 5)
summary(water.raw.ecoli)
```

## Exploratory Analysis

```{r}
# Import files and packages
library(ggplot2)
water.raw.ecoli <- read.csv("water.raw.ecoli.csv", stringsAsFactors = F)
water.raw.ecoli$time <- as.POSIXct(water.raw.ecoli$time, format = "%Y-%m-%d", tz = "GMT")

# CORRELATIONS BETWEEN PARAMETERS AND E.COLI
cor.ecoli <- NULL
for(i in 5:length(water.raw.ecoli)){
  assign(x = paste("x", i, sep = "-"), value = cor(x = water.raw.ecoli[i], y = water.raw.ecoli$E.coli.C.MF.no.100ml, use = "complete.obs"))
  cor.ecoli <- rbind(cor.ecoli, get(paste("x", i, sep = "-")))
}
rm(list = ls(pattern = "x-"))
rm(i)
row.names(cor.ecoli) <- colnames(water.raw.ecoli[,5:length(water.raw.ecoli)])
cor.ecoli
```

With the table of the correlations of e. coli to each other determinand, it becomes apparent that normal linear models won't be an effective approach to building a predictive model.

To get a closer look at the relationship of e. coli concentration to each determinand, e. coli is plotted on the y-axis and each other determinand is plotted on the x-axis. 

```{r error = FALSE}
# Ammonia vs. e. coli: no correlation
ggplot(water.raw.ecoli, aes(x = `Ammonia.N..mg.l`, y = `E.coli.C.MF.no.100ml`, color = materialtype)) + geom_point(alpha = 0.2)
# COD vs. e. coli: no correlation
ggplot(water.raw.ecoli, aes(x = `COD.as.O2.mg.l`, y = `E.coli.C.MF.no.100ml`, color = materialtype)) + geom_point(alpha = 0.2)
# Nitrate vs. e. coli: more high e. coli at low nitrate
ggplot(water.raw.ecoli, aes(x = `Nitrate.N.mg.l`, y = `E.coli.C.MF.no.100ml`, color = materialtype)) + geom_point(alpha = 0.2)
# Nitrite vs. e. coli: nearly no correlation
ggplot(water.raw.ecoli, aes(x = `Nitrite.N.mg.l`, y = `E.coli.C.MF.no.100ml`, color = materialtype)) + geom_point(alpha = 0.2)
# Dissolved Oxygen 2 vs. e. coli:  no high ecoli after a certain point
ggplot(water.raw.ecoli, aes(x = `Oxygen.Diss.mg.l`, y = `E.coli.C.MF.no.100ml`, color = materialtype)) + geom_point(alpha = 0.2)
# pH vs. e. coli: high ecoli in a range
ggplot(water.raw.ecoli, aes(x = `pH.phunits`, y = `E.coli.C.MF.no.100ml`, color = materialtype)) + geom_point(alpha = 0.2)
# salinity vs. e. coli: high e. coli at lower salinity
ggplot(water.raw.ecoli, aes(x = `SALinsitu.ppt`, y = `E.coli.C.MF.no.100ml`, color = materialtype)) + geom_point(alpha = 0.2)
# Solids dissolved vs. e. coli: decreasing e. coli with increasing solids
ggplot(water.raw.ecoli, aes(x = `Sld.Sus.105C.mg.l`, y = `E.coli.C.MF.no.100ml`, color = materialtype)) + geom_point(alpha = 0.2)
# Temp vs. e. coli: high ecoli in a range
ggplot(water.raw.ecoli, aes(x = `Temp.Water.cel`, y = `E.coli.C.MF.no.100ml`, color = materialtype)) + geom_point(alpha = 0.2)
```
