# Wrangling Process

The data wrangling process is divided into two segments, 1) combining and cleaning the UK water quality data sets from 2013-2017 and 2) filtering the combined data and restructuring it to tidy format. This is done to minimize the file size of the raw data (UK water quality original data is ~3.3 GB, but after segment 1 is cut to ~1.0 GB).

## Segment 1

After combining the data sets of each year into one data set, the file size was reduced by deleting unnecessary columns. The remaining columns were then renamed to be more concise and intuitive. This was saved and exported as "water.raw.csv".

## Segment 2

Importing "water.raw.csv" from segment 1, the data set was then filtered to select only the 5 most common material types and for the most important determinands. This was done to keep the file size manageable and make patterns in the data more visible. 

Having cut the dataset down to the desired subsets, this was then reorganized into tidy format with spread() and aggregate(). After using spread(), each row had only one determinand measurement and had missing values in all other determinand columns. To be able to plot each determinand against e. coli concentration, aggregate() was used to combine these rows. Each row that had the same sample time, location, and material type had their determinands summed together, ignoring NA values. An example of this transformation is shown below.

```{r echo = F, message = F}
library(dplyr)
library(tidyr)
colnames <- c("sample", "time", "location", "determinand.label", "result")
sample1 <- c(1, "05/13/14", "A", "pH", 7)
sample2 <- c(2, "05/13/14", "A", "Temp", 20)
sample3 <- c(3, "05/13/14", "A", "Oxygen", 0.88)
sample4 <- c(4, "05/13/14", "A", "ecoli", 650)
sample5 <- c(5, "05/20/14", "A", "pH", 8)
sample6 <- c(6, "05/20/14", "A", "ecoli", 700)
sample7 <- c(7, "05/20/14", "B", "pH", 9)
sample8 <- c(8, "05/20/14", "B", "Temp", 23)
sample9 <- c(9, "05/20/14", "B", "ecoli", 750)
rawdata <- as.data.frame(rbind(sample1, sample2, sample3, sample4, sample5, sample6, sample7, sample8, sample9))
colnames(rawdata) <- colnames
rawdata$result <- as.numeric(rawdata$result)
```

```{r}
rawdata
data <- spread(rawdata, key = determinand.label, value = result)
data
data$sample <- NULL
finaldata <- aggregate(data[,3:6], data[,1:2], FUN = sum, na.rm = T)
finaldata[finaldata == 0] <- NA
finaldata
```

Because predicting e. coli levels is the goal, this was then filtered again to include only rows that had an e. coli concentration measurement. 

This was saved and exported as "water.raw.ecoli.csv" to be used for explortaory analysis.